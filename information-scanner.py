import os.path
import argparse
import subprocess
import time
import tqdm
import xml.etree.ElementTree as ET

parser = argparse.ArgumentParser(prog='Information Scanner', 
                                usage='python firebase-scan.py apk-file', 
                                epilog='Example: python firebase-scan.py example.apk', 
                                description='A pen-testing tool to automatically finding attack surface')

parser.add_argument('apkfile', metavar='apk-file', help='name of the apk file')

#Check file existed
def isExist(filename):
    return os.path.exists(filename)


#Decode apk file
def decodeAPK(filename):
    cmd = subprocess.Popen(['apktool', 'd','-f', filename], stdout=subprocess.PIPE,shell=True)
    pbar = tqdm.tqdm(range (100), desc=" [-] Analyzing APK", ncols=80)
    for i in pbar:
        time.sleep(0.01)
        if (i == 50):
            while (cmd.stdout.readline().decode("utf-8")):
                time.sleep(0.01)
        if (i == 99):
            pbar.set_description(" [+] Analyzing APK")

#Scan Manifest file
def scanInfor(filepath):
    manifestfile = ""  + filepath + "/AndroidManiFest.xml"
    tree = ET.parse(manifestfile)
    root = tree.getroot()

    #Get package name
    package_name = root.attrib.get("package")
    print("Package name:", package_name)

    #Scan tag exported flag set true
    activities = []
    services = []
    receivers = []
    providers = []
    permissions = []
    for element in root.iter():
        if(element.attrib.get("{http://schemas.android.com/apk/res/android}exported") == 'true'):
            if(element.tag == 'activity'):
                activities.append(element.attrib.get("{http://schemas.android.com/apk/res/android}name"))
            elif element.tag == 'service':
                services.append(element.attrib.get("{http://schemas.android.com/apk/res/android}name"))
            elif element.tag == 'receiver':
                receivers.append(element.attrib.get("{http://schemas.android.com/apk/res/android}name"))
            elif element.tag == 'providers':
                providers.append(element.attrib.get("{http://schemas.android.com/apk/res/android}name"))
        
        if(element.tag == 'uses-permission'):
            permissions.append(element.attrib.get("{http://schemas.android.com/apk/res/android}name"))
    
    print(activities)
    print(services)
    print(receivers)
    print(providers)
    print(permissions)

    

def main():
    args = parser.parse_args()
    apkfile = args.apkfile
    print("APK file: " + apkfile)

    # check file decoded
    if isExist(apkfile[:-4]):
        a = input("This file has been decoded, decode  again? (Y/n)  ")
        if (a == 'Y' or a == 'y' or a == ''):
            decodeAPK(apkfile)
    else:
        decodeAPK(apkfile)
    
    print("\nScanning Information:")
    scanInfor(apkfile[:-4])

if __name__ == "__main__":
    main()