import os.path
import argparse
import subprocess
import time
import tqdm
import json
import requests
from requests_toolbelt.multipart.encoder import MultipartEncoder
from colorama import Fore, Back

banner = r"""
    ____      ____           _____
   /  _/___  / __/___  _____/ ___/_________ _____  ____  ___  _____
   / // __ \/ /_/ __ \/ ___/\__ \/ ___/ __ `/ __ \/ __ \/ _ \/ ___/
 _/ // / / / __/ /_/ / /   ___/ / /__/ /_/ / / / / / / /  __/ /
/___/_/ /_/_/  \____/_/   /____/\___/\__,_/_/ /_/_/ /_/\___/_/

                                                            phongdk

"""
parser = argparse.ArgumentParser(prog='Information Scanner', 
                                usage='python firebase-scan.py apk-file', 
                                epilog='Example: python firebase-scan.py example.apk', 
                                description='A pen-testing tool to automatically finding attack surface')

parser.add_argument('apkfile', metavar='apk-file', help='name of the apk file')

activities = []
services = []
receivers = []
providers = []
permissions = []
dangerous_perm = []
isBackup = False
isDebug = False

SERVER = "https://b53b-113-20-108-53.ngrok-free.app"
APIKEY = '6ddca0234867c7290a0bcde9f6b83d0a58d9b65a16d5e6f934cdd6cb374c6581'
apkfile = ''

#Upload file APK 
def upload(apkfile):
    multipart_data = MultipartEncoder(fields={'file': (apkfile, open(apkfile, 'rb'), 'application/octet-stream')})
    headers = {'Content-Type': multipart_data.content_type, 'Authorization': APIKEY}
    pbar = tqdm.tqdm(range (100), desc=" [-] Uploading...", ncols=80)
    response = requests.post(SERVER + '/api/v1/upload', data=multipart_data, headers=headers)
    for i in pbar:
        time.sleep(0.01)
        if (i == 99):
            pbar.set_description(" [+] Upload completed")
    return response.text

#Scanning APK
def scanInfor(data):
    print("Scanning file:")
    post_dict = json.loads(data)
    headers = {'Authorization': APIKEY}
    pbar = tqdm.tqdm(range (100), desc=" [-] Scanning...", ncols=80)
    response = requests.post(SERVER + '/api/v1/scan', data=post_dict, headers=headers)
    for i in pbar:
        time.sleep(0.01)
        if (i == 99):
            pbar.set_description(" [+] Scan completed")
    res = json.loads(response.text)
    activities = eval(res['exported_activities'])
    
    for x, y in res['permissions'].items():
        permissions.append(x)
        if y['status'] == 'dangerous':
            dangerous_perm.append(x)
    for i in res['manifest_analysis']['manifest_findings']:
        if i['rule'] == 'app_is_debuggable':
            isDebug = True
        if i['rule'] == 'app_allowbackup':
            isBackup = True
        if i['rule'] == 'explicitly_exported' or i['rule'] == 'exported_intent_filter_exists':
            if i['component'][0] == 'Broadcast Receiver':
                receivers.append(i['component'][1])
            elif i['component'][0] == 'Content Provider':
                providers.append(i['component'][1])
            elif i['component'][0] == 'Service':
                services.append(i['component'][1])
    
    print('\nApplications Permissions:')
    for i in permissions:
        if i in dangerous_perm:
            continue
        else: print('  ' + Fore.CYAN + i)
    
    for i in dangerous_perm:
        print('  ' + Fore.RED + i)

    print(Fore.WHITE + '\nAttack surface:')
    print('  ',len(activities),'activities exported')
    print('  ',len(services),'services exported')
    print('  ',len(receivers),'broadcast receivers exported')
    print('  ',len(providers),'content provider exported')
    if isBackup: print(Fore.YELLOW + '    is allow backup')
    if isDebug: print('    is debuggable')

    print(Fore.WHITE + 'x')
    
    #print(len(activities),len(receivers),len(services),len(providers))


#Check file existed
def isExist(filename):
    return os.path.exists(filename)

def activityAttack():
    while True:
        print("Select acitivity by id:")
        for i,v in enumerate(activities):
            print(f"  {i}. {v}")
        user_input = (input('> '))
        if user_input == 'back' or user_input == 'b':
            attack()
            break
        elif user_input == 'exit':
            break
        try:
            if int(user_input) > len(activities)-1:
                print('Error, Please select again\n')
            else:
                act_name = activities[int(user_input)]
                parts = act_name.rsplit('.',1)
                act_name = f"{parts[0]}/.{parts[1]}"
                try:
                    arr_argv = ['adb', 'shell','am', 'start','-n' , act_name]
                    cmd = subprocess.Popen(arr_argv, stdout=subprocess.PIPE,stderr=subprocess.PIPE,shell=True)
                    print('Activity is started, please check your device!!!\n')
                except:
                    print('Error, Please ensure your virtual machine is opened!!!')
        except ValueError : 
            print('Error, Please select again\n')
    
def serviceAttack():
    while True:
        print("Select service by id:")
        for i,v in enumerate(services):
            print(f"  {i}. {v}")
        user_input = (input('> '))
        if user_input == 'back' or user_input == 'b':
            attack()
            break
        elif user_input == 'exit':
            break
        try:
            if int(user_input) > len(services)-1:
                print('Error, Please select again\n')
            else:
                serv_name = services[int(user_input)]
                parts = serv_name.rsplit('.',1)
                serv_name = f"{parts[0]}/.{parts[1]}"

                arr_argv = ['adb', 'shell','am', 'startservice', serv_name]
                cmd = subprocess.Popen(arr_argv, stdout=subprocess.PIPE,stderr=subprocess.PIPE,shell=True)
                print('Service is started, please check your device')
        except ValueError : 
            print('Error, Please select again\n')

def receiverAttack():
    while True:
        print("Select receiver by id:")
        for i,v in enumerate(receivers):
            print(f"  {i}. {v}")
        user_input = (input('> '))
        if user_input == 'back' or user_input == 'b':
            attack()
            break
        elif user_input == 'exit':
            break
        try:
            if int(user_input) > len(services)-1:
                print('Error, Please select again\n')
            else:
                recei_name = receivers[int(user_input)]
                parts = recei_name.rsplit('.',1)
                recei_name = f"{parts[0]}/.{parts[1]}"

                arr_argv = ['adb', 'shell','am', 'broadcast', recei_name]
                cmd = subprocess.Popen(arr_argv, stdout=subprocess.PIPE,stderr=subprocess.PIPE,shell=True)
                print('Broadcast is started, please check your device')
        except ValueError : 
            print('Error, Please select again\n')


def providerAttack():
    while True:
        print("Select content provider by id:")
        for i,v in enumerate(providers):
            print(f"  {i}. {v}")
        user_input = (input('> '))
        if user_input == 'back' or user_input == 'b':
            attack()
            break
        elif user_input == 'exit':
            break
        try:
            if int(user_input) > len(services)-1:
                print('Error, Please select again\n')
            else:
                print('test')
        except ValueError : 
            print('Error, Please select again\n')
    

def attack():
    while True:
        print('\nWhat\'s components you wanna attack?\n  0. activity\n  1. service\n  2. receiver\n  3. content providers')
        user_input = input('> ')
        if user_input.lower() == 'exit':
            break
        else:
            if user_input == '0':
                if(len(activities)>0):
                    activityAttack()
                else:
                    print('This componnent cannot attack because cannot find attack surface')
                break      
            elif user_input == '1':
                if(len(services)>0):
                    serviceAttack()
                else:
                    print('This componnent cannot attack because cannot find attack surface')
                break 
            elif user_input == '2':
                if(len(receivers)>0):
                    receiverAttack()
                else:
                    print('This componnent cannot attack because cannot find attack surface')
                break 
            elif user_input == '3':
                if(len(providers)>0):
                    providerAttack()
                else:
                    print('This componnent cannot attack because cannot find attack surface')
                break 
            else:
                print('Error, Please select again\n')

    
def main():
    print(banner)
    args = parser.parse_args()
    apkfile = args.apkfile
    if '.apk' not in apkfile:
        print("Invalid APK File")
    else:
        print("APK file: " + apkfile)
        data = upload(apkfile)
        print("\nScanning Information:")
        scanInfor(data)

        # a = input("Do you want to attack components exported? (Y/n) ")
        # if (a == 'Y' or a == 'y' or a == ''):
        #     attack()
if __name__ == "__main__":
    main()