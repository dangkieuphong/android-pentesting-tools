import os.path
import argparse
import subprocess
import time
import tqdm
import xml.etree.ElementTree as ET
import os
import requests
from requests_toolbelt.multipart.encoder import MultipartEncoder




banner = r"""
    ____      ____           _____
   /  _/___  / __/___  _____/ ___/_________ _____  ____  ___  _____
   / // __ \/ /_/ __ \/ ___/\__ \/ ___/ __ `/ __ \/ __ \/ _ \/ ___/
 _/ // / / / __/ /_/ / /   ___/ / /__/ /_/ / / / / / / /  __/ /
/___/_/ /_/_/  \____/_/   /____/\___/\__,_/_/ /_/_/ /_/\___/_/

                                                            phongdk

"""
parser = argparse.ArgumentParser(prog='Information Scanner', 
                                usage='python firebase-scan.py apk-file', 
                                epilog='Example: python firebase-scan.py example.apk', 
                                description='A pen-testing tool to automatically finding attack surface')

parser.add_argument('apkfile', metavar='apk-file', help='name of the apk file')


SERVER = "http://localhost:8000"
FILE = 'AndroGoat.apk'
APIKEY = '286a755dfce115f42eb02b6ce7709bd1fb787164e3c85b41dacb3df6e654d023'
activities = []
services = []
receivers = []
providers = []
permissions = []
isBackup = False
isDebug = False


#Upload file to MOBSF
def upload():
    print("Uploading file")
    multipart_data = MultipartEncoder(fields={'file': (FILE, open(FILE, 'rb'), 'application/octet-stream')})
    headers = {'Content-Type': multipart_data.content_type, 'Authorization': APIKEY}
    response = requests.post(SERVER + '/api/v1/upload', data=multipart_data, headers=headers)
    print(response.text)
    return response.text

#Check file existed
def isExist(filename):
    return os.path.exists(filename)


#Decode apk file
def decodeAPK(filename):
    cmd = subprocess.Popen(['apktool', 'd','-f', filename], stdout=subprocess.PIPE,shell=True)
    pbar = tqdm.tqdm(range (100), desc=" [-] Analyzing APK", ncols=80)
    for i in pbar:
        time.sleep(0.01)
        if (i == 50):
            while (cmd.stdout.readline().decode("utf-8")):
                time.sleep(0.01)
        if (i == 99):
            pbar.set_description(" [+] Analyzing APK")

#Scan Manifest file
def scanInfor(filepath):
    manifestfile = ""  + filepath + "/AndroidManiFest.xml"
    tree = ET.parse(manifestfile)
    root = tree.getroot()

    #Get package name
    package_name = root.attrib.get("package")

    #Scan tag exported flag set true
    pbar = tqdm.tqdm(range (100), desc=" [-] Scanning", ncols=80)
    for i in pbar:
        time.sleep(0.01)
        if (i == 99):
            pbar.set_description(" [+] Scan completed")

    print("\nPackage name:", package_name)
    for element in root.iter():
        if(element.attrib.get("{http://schemas.android.com/apk/res/android}exported") == 'true'):
            if element.tag == 'activity':
                activities.append(element.attrib.get("{http://schemas.android.com/apk/res/android}name"))
            elif element.tag == 'service':
                services.append(element.attrib.get("{http://schemas.android.com/apk/res/android}name"))
            elif element.tag == 'receiver':
                receivers.append(element.attrib.get("{http://schemas.android.com/apk/res/android}name"))
            elif element.tag == 'provider':
                providers.append(element.attrib.get("{http://schemas.android.com/apk/res/android}name"))
        
        if('uses-permission' in element.tag):
            permissions.append(element.attrib.get("{http://schemas.android.com/apk/res/android}name"))
        
        if element.tag == 'application':
            if element.attrib.get("{http://schemas.android.com/apk/res/android}allowBackup") == 'true' :
                isBackup = True
            if element.attrib.get("{http://schemas.android.com/apk/res/android}debuggable") == 'true':
                isDebug = True
    print('\nApplication Permission:')
    for perm in permissions:
        print("  "+ perm)

    print("\nAttack Surface:")
    print("  ", len(activities) ," activities exported")
    print("  ", len(services) ," services exported")
    print("  ", len(receivers) ," receivers exported")
    print("  ", len(providers) ," content providers exported")
    if isDebug: print("\tis debuggable")
    if isBackup: print("\tis allow backup")


def activityAttack():
    while True:
        print("Select acitivity by id:")
        for i,v in enumerate(activities):
            print(f"  {i}. {v}")
        user_input = (input('> '))
        if user_input == 'back' or user_input == 'b':
            attack()
            break
        elif user_input == 'exit':
            break
        try:
            if int(user_input) > len(activities)-1:
                print('Error, Please select again\n')
            else:
                act_name = activities[int(user_input)]
                parts = act_name.rsplit('.',1)
                act_name = f"{parts[0]}/.{parts[1]}"
                try:
                    arr_argv = ['adb', 'shell','am', 'start','-n' , act_name]
                    cmd = subprocess.Popen(arr_argv, stdout=subprocess.PIPE,stderr=subprocess.PIPE,shell=True)
                    print('Activity is started, please check your device!!!\n')
                except:
                    print('Error, Please ensure your virtual machine is opened!!!')
        except ValueError : 
            print('Error, Please select again\n')
    
def serviceAttack():
    while True:
        print("Select service by id:")
        for i,v in enumerate(services):
            print(f"  {i}. {v}")
        user_input = (input('> '))
        if user_input == 'back' or user_input == 'b':
            attack()
            break
        elif user_input == 'exit':
            break
        try:
            if int(user_input) > len(services)-1:
                print('Error, Please select again\n')
            else:
                serv_name = services[int(user_input)]
                parts = serv_name.rsplit('.',1)
                serv_name = f"{parts[0]}/.{parts[1]}"

                arr_argv = ['adb', 'shell','am', 'startservice', serv_name]
                cmd = subprocess.Popen(arr_argv, stdout=subprocess.PIPE,stderr=subprocess.PIPE,shell=True)
                print('Service is started, please check your device')
        except ValueError : 
            print('Error, Please select again\n')

def receiverAttack():
    while True:
        print("Select receiver by id:")
        for i,v in enumerate(receivers):
            print(f"  {i}. {v}")
        user_input = (input('> '))
        if user_input == 'back' or user_input == 'b':
            attack()
            break
        elif user_input == 'exit':
            break
        try:
            if int(user_input) > len(services)-1:
                print('Error, Please select again\n')
            else:
                recei_name = receivers[int(user_input)]
                parts = recei_name.rsplit('.',1)
                recei_name = f"{parts[0]}/.{parts[1]}"

                arr_argv = ['adb', 'shell','am', 'broadcast', recei_name]
                cmd = subprocess.Popen(arr_argv, stdout=subprocess.PIPE,stderr=subprocess.PIPE,shell=True)
                print('Broadcast is started, please check your device')
        except ValueError : 
            print('Error, Please select again\n')


def providerAttack():
    while True:
        print("Select content provider by id:")
        for i,v in enumerate(providers):
            print(f"  {i}. {v}")
        user_input = (input('> '))
        if user_input == 'back' or user_input == 'b':
            attack()
            break
        elif user_input == 'exit':
            break
        try:
            if int(user_input) > len(services)-1:
                print('Error, Please select again\n')
            else:
                print('test')
        except ValueError : 
            print('Error, Please select again\n')
    

def attack():
    while True:
        print('\nWhat\'s components you wanna attack?\n  0. activity\n  1. service\n  2. receiver\n  3. content providers')
        user_input = input('> ')
        if user_input.lower() == 'exit':
            break
        else:
            if user_input == '0':
                if(len(activities)>0):
                    activityAttack()
                else:
                    print('This componnent cannot attack because cannot find attack surface')
                break      
            elif user_input == '1':
                if(len(services)>0):
                    serviceAttack()
                else:
                    print('This componnent cannot attack because cannot find attack surface')
                break 
            elif user_input == '2':
                if(len(receivers)>0):
                    receiverAttack()
                else:
                    print('This componnent cannot attack because cannot find attack surface')
                break 
            elif user_input == '3':
                if(len(providers)>0):
                    providerAttack()
                else:
                    print('This componnent cannot attack because cannot find attack surface')
                break 
            else:
                print('Error, Please select again\n')

    
def main():
    print(banner)
    args = parser.parse_args()
    apkfile = args.apkfile
    if '.apk' not in apkfile:
        print("Invalid APK File")
    else:
        print("APK file: " + apkfile)

        # check file decoded
        if isExist(apkfile[:-4]):
            a = input("This file has been decoded, decode  again? (Y/n)  ")
            if (a == 'Y' or a == 'y'):
                decodeAPK(apkfile)
        else:
            decodeAPK(apkfile)
        
        print("\nScanning Information:")
        scanInfor(apkfile[:-4])

        a = input("Do you want to attack components exported? (Y/n) ")
        if (a == 'Y' or a == 'y' or a == ''):
            attack()
if __name__ == "__main__":
    main()